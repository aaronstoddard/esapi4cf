<!DOCTYPE html>
<!--[if lt IE 7]>      <html lang="en" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html lang="en" class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html lang="en" class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<title>Authentication Tutorial :: ESAPI4CF</title>
<meta name="description" content="" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css" />
<!--<link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap-theme.min.css" />-->
<style>body{padding-top:60px;padding-bottom:40px;}</style>
<link rel="stylesheet" href="../css/main.css" />
<script src="../js/vendor/modernizr-2.6.2-respond-1.1.0.min.js"></script>
</head>
<body>
<!--[if lt IE 9]><p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p><![endif]-->

<nav id="bannerNav" class="navbar navbar-default navbar-inverse navbar-fixed-top" role="navigation"></nav>

<div class="container">

	<!-- BEGIN content -->
	
	<div class="page-header">
		<h1 class="text-center">Authentication</h1>
	</div>
<!--	
	<p>In this tutorial we are going to cover the Authentication module in ESAPI4CF.  We will be adding onto our Application.cfc that we defined in the Setup tutorial in order to validate our users, diving into the what the login process does, going over the other functionality provided by this module, and lastly covering how to implement your own user base into ESAPI4CF.</p>
	
	
	
<h4>Background</h4>
<p>Instance of the ESAPI's authenticator component can be created as:</p>

<p class="newsItem"><code>authenticator = application.ESAPI.authenticator();</code></p>

<p>You do not need users.txt.  ESAPI will create this file when your application requests to create its first user.</p>

<h4>Create Users</h4>
There are two ways to create users safely in ESAPI:
<p>Use FileBasedAuthenticator.cfm to generate users.txt for the first time.  To do this follow this link: <a href="../org/owasp/esapi/reference/FileBasedAuthenticator.cfm">FileBasedAuthenticator.cfm</a></p>

To create users from within your application, use:
<p class="newsItem"><code>application.ESAPI.authenticator().createUser(username, password, password)</code></p>
Two copies of the new password are required to encourage user interface designers to include a "re-type password" field in their forms.

<br />''Note:Users created with the createUser method are disabled and locked by default.'' <br /><br /> You must call:
<p class="newsItem">
<code>
application.ESAPI.authenticator().getUserByAccountName(username).enable();<br>
application.ESAPI.authenticator().getUserByAccountName(username).unlock();
</code>
</p>

<h4>Login</h4>
If you use the default ESAPI authenticator, you will need your login page to use SSL, so be sure to have a keystore file and adjust your server configuration settings to account for this.  If you are using Apache Tomcat, please see the readme included in the latest release of the <a href="https://www.owasp.org/index.php/ESAPI_Swingset">ESAPI Swingset</a> for help setting up SSL.

<br/><br/>
<a href="http://tomcat.apache.org/tomcat-6.0-doc/ssl-howto.html##Configuration">Set up SSL for tomcat 6.0</a>

<br/><br/>

<p>To authenticate a user, call:</p>
<p class="newsItem"><code>user = application.ESAPI.authenticator().login(application.ESAPI.currentRequest(), application.ESAPI.currentResponse());</code></p>

Be sure to set the UsernameParameterName and PasswordParameterName variables in ESAPI.properties.  The login method will use those variable names to take the username and password that the user entered from the currentRequest().

<h4>Logout</h4>
To log a User out, simply call:
<p class="newsItem">
<code>user = application.ESAPI.authenticator().logout;</code>
</p>

<h4>ESAPI User Interface: </h4>
<p>ESAPI's User Interface provides support to store lot of information that an application must store for each user in order to enforce security properly.</p>
<p>A user account can be in one of several states. When first created, a User should be disabled, not expired, and unlocked. To start using the account, an administrator should enable the account. The account can be locked for a number of reasons, most commonly because they have failed login for too many times. Finally, the account can expire after the expiration date has been reached. The User must be enabled, not expired, and unlocked in order to pass authentication. </p>


	<p>...</p>

<pre>
function onRequestStart() {
	try {
		// register request and response in ESAPI4CF
		application.ESAPI.httpUtilities().setCurrentHTTP(getPageContext().getRequest(), getPageContext().getResponse());
	
		// get references to the registered request/response safe wrappers
		var httpRequest = application.ESAPI.currentRequest();
		var httpResponse = application.ESAPI.currentResponse();

		// if the user can be identified via the sessionID, the following will set "currentUser"
		// in the Authenticator for consistent user identification across all requests in log messages
		var httpSession = httpRequest.getSession(false);
		if(isObject(httpSession)) {
			try {
				// this will verify authentication for your entire web application
				// rememberToken is not implemented by default; if you wish to use rememberToken,
				// you must call it inside your login() method after the user has been verified
				application.ESAPI.authenticator().login(httpRequest, httpResponse);
			}
			catch(org.owasp.esapi.errors.AuthenticationException e) {
				// Possible exceptions:
				// Attempt to login with an insecure request : Received non-SSL request
				// Attempt to login with an insecure request : Received request using GET when only POST is allowed
				// Attempt to access secure content with an insecure request : Received non-SSL request
				loginFailure(e.message, e.detail);
			}
			catch(org.owasp.esapi.errors.AuthenticationCredentialsException e) {
				// Possible exceptions:
				// Invalid request : Request or response objects were empty
				// Authentication failed : blank username/password
				// Authentication failed : username does not exist
				loginFailure(e.message, e.detail);
			}
			catch(org.owasp.esapi.errors.AuthenticationLoginException e) {
				// Possible exceptions:
				// Login failed : Missing password
				// Login failed : Disabled user attempt to login
				// Login failed : Locked user attempt to login
				// Login failed : Expired user attempt to login
				// Login failed : Incorrect password provided
				// Login failed : Anonymous user cannot be set to current user
				// Login failed : Disabled user cannot be set to current user
				// Login failed : Locked user cannot be set to current user
				// Login failed : Expired user cannot be set to current user
				// Login failed : Session inactivity timeout
				// Login failed : Session absolute timeout
				loginFailure(e.message, e.detail);
			}
		}
		
		// log this request, obfuscating any parameter named password
		application.ESAPI.httpUtilities().logHTTPRequest(httpRequest, application.logger, application.ignoredByLogger);
	}
	catch(Any e) {
		application.logger.error(application.ESAPI4JLogger.SECURITY_FAILURE, false, "Error in ESAPI security filter: " & e.message, e);
		application.ESAPI.currentRequest().setAttribute("message", e.message);
	}
	
	...other code...
}
</pre>

	<p>...</p>
	
<pre>
function loginFailure(message, detail) {
	// the ESAPI4CF exception was already logged so we do not have to do anything with the message/detail
	// unless you have specific business requirements to do so.
	
	// let's provide a whitelist of pages that do not require authentication (if needed)
	if (listFindNoCase("forgotpassword.cfm,...", cgi....)) {
		return;
	}
	
	// we were not in the whitelist so we must fail this request
	location();
}
</pre>
-->


	<!-- END content -->

	<hr />
    <footer>
        <p>Copyright &#169; 2013 OWASP ESAPI4CF</p>
    </footer>
		
</div>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="../js/vendor/jquery-1.10.1.min.js"><\/script>')</script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js"></script>
<script src="../js/plugins.js"></script>
<script src="../js/main.js"></script>
<script>
var _gaq=[['_setAccount','UA-828502-5'],['_trackPageview']];
(function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
g.src='//www.google-analytics.com/ga.js';
s.parentNode.insertBefore(g,s)}(document,'script'));
</script>
</body>
</html>